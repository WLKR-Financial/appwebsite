{"ast":null,"code":"var _jsxFileName = \"/Users/safahi/Documents/GitHub/appwebsite/src/contexts/BuySell/BuySellProvider.tsx\",\n    _s = $RefreshSig$();\n\nimport React, { useCallback, useEffect, useState } from 'react';\nimport Web3 from 'web3';\nimport { currencyTokens } from 'constants/currencyTokens';\nimport { BedIndex, Bitcoin2xFlexibleLeverageIndex, DataIndex, WLKRInnovation, // Added WLKR\nEthereum2xFlexibleLeverageIndex, Ethereum2xFLIP, GmiIndex, IEthereumFLIP, IMaticFLIP, WalkerToken, // Added WLKRR\nMatic2xFLIP, CandleToken // Added CNDL\n} from 'constants/productTokens';\nimport { TransactionStatusType } from 'contexts/TransactionWatcher';\nimport useBalances from 'hooks/useBalances';\nimport useTransactionWatcher from 'hooks/useTransactionWatcher';\nimport useWallet from 'hooks/useWallet';\nimport BigNumber from 'utils/bignumber';\nimport { MAINNET_CHAIN_DATA } from 'utils/connectors';\nimport { fromWei, waitTransaction } from 'utils/index';\nimport trackReferral from 'utils/referralApi';\nimport { getZeroExTradeData } from 'utils/zeroExUtils';\nimport BuySellContext from './BuySellContext';\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\n\nconst BuySellProvider = ({\n  children\n}) => {\n  _s();\n\n  const [buySellToken, setBuySellToken] = useState('dpi');\n  const [isFetchingOrderData, setIsFetchingOrderData] = useState(false);\n  const [isUserBuying, setIsUserBuying] = useState(true);\n  const [activeField, setActiveField] = useState('currency');\n  const [buySellQuantity, setBuySellQuantity] = useState('');\n  const [selectedCurrency, setSelectedCurrency] = useState();\n  const [zeroExTradeData, setZeroExTradeData] = useState();\n  const [currencyOptions, setCurrencyOptions] = useState([]);\n  const {\n    onSetTransactionId,\n    onSetTransactionStatus\n  } = useTransactionWatcher();\n  const {\n    ethBalance,\n    wethBalancePolygon,\n    wlkrBalance,\n    // Added WLKR\n    wlkrBalancePolygon,\n    // Added WLKR\n    wlkrrBalance,\n    // Added WLKRR\n    wlkrrBalancePolygon,\n    // Added WLKRR\n    cndlBalance,\n    // Added CNDL\n    cndlBalancePolygon,\n    // Added CNDL\n    mviBalance,\n    mviBalancePolygon,\n    bedBalance,\n    gmiBalance,\n    dataBalance,\n    dataBalancePolygon,\n    ethfliBalance,\n    ethflipBalance,\n    btcfliBalance,\n    indexBalance,\n    daiBalance,\n    daiBalancePolygon,\n    usdcBalance,\n    usdcBalancePolygon,\n    iethFlipBalance,\n    maticFlipBalancePolygon,\n    imaticFlipBalancePolygon\n  } = useBalances();\n  const {\n    account,\n    ethereum,\n    chainId\n  } = useWallet();\n  useEffect(() => {\n    setCurrencyOptions(currencyTokens);\n    setSelectedCurrency(currencyTokens[0]);\n  }, []);\n\n  const getNetworkedBalance = (mainnetBalance, polygonBalance, decimals = 18) => {\n    return chainId && chainId === MAINNET_CHAIN_DATA.chainId ? fromWei(mainnetBalance, decimals) : fromWei(polygonBalance, decimals);\n  }; // eslint-disable-next-line\n\n\n  let spendingTokenBalance = new BigNumber(0);\n\n  if (!isUserBuying && buySellToken === WalkerToken.tokenSelector) {\n    spendingTokenBalance = fromWei(wlkrrBalance);\n  } else if (!isUserBuying && buySellToken === WLKRInnovation.tokenSelector) {\n    spendingTokenBalance = getNetworkedBalance(wlkrBalance, wlkrBalancePolygon);\n  } else if (!isUserBuying && buySellToken === Ethereum2xFlexibleLeverageIndex.tokenSelector) {\n    spendingTokenBalance = fromWei(ethfliBalance);\n  } else if (!isUserBuying && buySellToken === Ethereum2xFLIP.tokenSelector) {\n    spendingTokenBalance = fromWei(ethflipBalance);\n  } else if (!isUserBuying && buySellToken === IEthereumFLIP.tokenSelector) {\n    spendingTokenBalance = fromWei(iethFlipBalance);\n  } else if (!isUserBuying && buySellToken === Matic2xFLIP.tokenSelector) {\n    spendingTokenBalance = fromWei(maticFlipBalancePolygon);\n  } else if (!isUserBuying && buySellToken === IMaticFLIP.tokenSelector) {\n    spendingTokenBalance = fromWei(imaticFlipBalancePolygon);\n  } else if (!isUserBuying && buySellToken === Bitcoin2xFlexibleLeverageIndex.tokenSelector) {\n    spendingTokenBalance = fromWei(btcfliBalance);\n  } else if (!isUserBuying && buySellToken === CandleToken.tokenSelector) {\n    spendingTokenBalance = getNetworkedBalance(cndlBalance, cndlBalancePolygon);\n  } else if (!isUserBuying && buySellToken === BedIndex.tokenSelector) {\n    spendingTokenBalance = fromWei(bedBalance);\n  } else if (!isUserBuying && buySellToken === GmiIndex.tokenSelector) {\n    spendingTokenBalance = fromWei(gmiBalance);\n  } else if (!isUserBuying && buySellToken === DataIndex.tokenSelector) {\n    spendingTokenBalance = getNetworkedBalance(dataBalance, dataBalancePolygon);\n  } else if ((selectedCurrency === null || selectedCurrency === void 0 ? void 0 : selectedCurrency.label) === 'ETH') {\n    spendingTokenBalance = getNetworkedBalance(ethBalance, wethBalancePolygon);\n  } else if ((selectedCurrency === null || selectedCurrency === void 0 ? void 0 : selectedCurrency.label) === 'DAI') {\n    spendingTokenBalance = getNetworkedBalance(daiBalance, daiBalancePolygon);\n  } else if ((selectedCurrency === null || selectedCurrency === void 0 ? void 0 : selectedCurrency.label) === 'USDC') {\n    spendingTokenBalance = getNetworkedBalance(usdcBalance, usdcBalancePolygon, 6);\n  }\n\n  useEffect(() => {\n    if (!buySellQuantity) return;\n    setIsFetchingOrderData(true);\n    const isExactInputTrade = !isUserBuying || activeField === 'currency';\n    getZeroExTradeData(isExactInputTrade, isUserBuying, selectedCurrency.label || '', buySellToken || '', buySellQuantity || '', chainId || 1).then(data => {\n      setZeroExTradeData(data);\n      setIsFetchingOrderData(false);\n    });\n  }, [isUserBuying, selectedCurrency, activeField, buySellToken, buySellQuantity, chainId]);\n  const onExecuteBuySell = useCallback(async () => {\n    if (!account || !(zeroExTradeData === null || zeroExTradeData === void 0 ? void 0 : zeroExTradeData.sellAmount) || !selectedCurrency) return;\n    let requiredBalance = selectedCurrency === 'usdc' ? fromWei(new BigNumber(zeroExTradeData.sellAmount), 6) : fromWei(new BigNumber(zeroExTradeData === null || zeroExTradeData === void 0 ? void 0 : zeroExTradeData.sellAmount));\n    if (spendingTokenBalance.lt(requiredBalance)) return;\n    const web3 = new Web3(ethereum);\n    zeroExTradeData.from = account;\n    zeroExTradeData.gas = undefined; // use metamask estimated gas limit\n\n    try {\n      var _window, _window$localStorage;\n\n      const tx = web3.eth.sendTransaction(zeroExTradeData);\n      onSetTransactionStatus(TransactionStatusType.IS_APPROVING);\n      const response = await tx;\n      onSetTransactionId(response.transactionHash);\n      onSetTransactionStatus(TransactionStatusType.IS_PENDING);\n      const isSuccessful = await waitTransaction(ethereum, response.transactionHash);\n      const referralCode = ((_window = window) === null || _window === void 0 ? void 0 : (_window$localStorage = _window.localStorage) === null || _window$localStorage === void 0 ? void 0 : _window$localStorage.getItem('referral')) || '';\n\n      if (isSuccessful) {\n        onSetTransactionStatus(TransactionStatusType.IS_COMPLETED);\n        trackReferral(referralCode, response.transactionHash, 'COMPLETED', selectedCurrency, buySellToken, isUserBuying);\n      } else {\n        onSetTransactionStatus(TransactionStatusType.IS_FAILED);\n        trackReferral(referralCode, response.transactionHash, 'PENDING OR FAILED', selectedCurrency, buySellToken, isUserBuying);\n      }\n    } catch (e) {\n      // There is a problem here where any error that gets triggered will make it seem like\n      // the transaction failed. For example, the wallet continually polls the chain but fails\n      // to make the network request. The transaction may not have failed, but it would have\n      // triggered this error state.\n      onSetTransactionStatus(TransactionStatusType.IS_FAILED);\n    }\n  }, [account, isUserBuying, selectedCurrency, buySellToken, ethereum, onSetTransactionId, onSetTransactionStatus, spendingTokenBalance, zeroExTradeData]);\n\n  const onToggleIsUserBuying = () => {\n    // If the user is switching to sell, ensure `set` field can only be selected.\n    if (isUserBuying) {\n      onSetActiveField('set');\n    }\n\n    setIsUserBuying(!isUserBuying);\n  };\n\n  const onSetActiveField = field => {\n    setActiveField(field);\n    if (!isUserBuying) return; // set BuySellQuantity to the correct value\n\n    if (field === 'set') {\n      setBuySellQuantity((zeroExTradeData === null || zeroExTradeData === void 0 ? void 0 : zeroExTradeData.displayBuyAmount.toFixed(6)) || '');\n    } else {\n      setBuySellQuantity((zeroExTradeData === null || zeroExTradeData === void 0 ? void 0 : zeroExTradeData.displaySellAmount.toFixed(6)) || '');\n    }\n  };\n\n  const onSetBuySellQuantity = amount => {\n    setBuySellQuantity(amount);\n  };\n\n  const onSetSelectedCurrency = currency => {\n    setSelectedCurrency(currency);\n  };\n\n  return /*#__PURE__*/_jsxDEV(BuySellContext.Provider, {\n    value: {\n      buySellToken,\n      isFetchingOrderData,\n      isUserBuying,\n      activeField,\n      selectedCurrency,\n      spendingTokenBalance,\n      zeroExTradeData,\n      currencyOptions,\n      buySellQuantity,\n      onSetBuySellToken: setBuySellToken,\n      onToggleIsUserBuying,\n      onSetActiveField,\n      onSetSelectedCurrency,\n      onSetBuySellQuantity,\n      onExecuteBuySell\n    },\n    children: children\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 261,\n    columnNumber: 5\n  }, this);\n};\n\n_s(BuySellProvider, \"CIVadGWFJci7wb2khBclEQ7RZGU=\", false, function () {\n  return [useTransactionWatcher, useBalances, useWallet];\n});\n\n_c = BuySellProvider;\nexport default BuySellProvider;\n\nvar _c;\n\n$RefreshReg$(_c, \"BuySellProvider\");","map":{"version":3,"sources":["/Users/safahi/Documents/GitHub/appwebsite/src/contexts/BuySell/BuySellProvider.tsx"],"names":["React","useCallback","useEffect","useState","Web3","currencyTokens","BedIndex","Bitcoin2xFlexibleLeverageIndex","DataIndex","WLKRInnovation","Ethereum2xFlexibleLeverageIndex","Ethereum2xFLIP","GmiIndex","IEthereumFLIP","IMaticFLIP","WalkerToken","Matic2xFLIP","CandleToken","TransactionStatusType","useBalances","useTransactionWatcher","useWallet","BigNumber","MAINNET_CHAIN_DATA","fromWei","waitTransaction","trackReferral","getZeroExTradeData","BuySellContext","BuySellProvider","children","buySellToken","setBuySellToken","isFetchingOrderData","setIsFetchingOrderData","isUserBuying","setIsUserBuying","activeField","setActiveField","buySellQuantity","setBuySellQuantity","selectedCurrency","setSelectedCurrency","zeroExTradeData","setZeroExTradeData","currencyOptions","setCurrencyOptions","onSetTransactionId","onSetTransactionStatus","ethBalance","wethBalancePolygon","wlkrBalance","wlkrBalancePolygon","wlkrrBalance","wlkrrBalancePolygon","cndlBalance","cndlBalancePolygon","mviBalance","mviBalancePolygon","bedBalance","gmiBalance","dataBalance","dataBalancePolygon","ethfliBalance","ethflipBalance","btcfliBalance","indexBalance","daiBalance","daiBalancePolygon","usdcBalance","usdcBalancePolygon","iethFlipBalance","maticFlipBalancePolygon","imaticFlipBalancePolygon","account","ethereum","chainId","getNetworkedBalance","mainnetBalance","polygonBalance","decimals","spendingTokenBalance","tokenSelector","label","isExactInputTrade","then","data","onExecuteBuySell","sellAmount","requiredBalance","lt","web3","from","gas","undefined","tx","eth","sendTransaction","IS_APPROVING","response","transactionHash","IS_PENDING","isSuccessful","referralCode","window","localStorage","getItem","IS_COMPLETED","IS_FAILED","e","onToggleIsUserBuying","onSetActiveField","field","displayBuyAmount","toFixed","displaySellAmount","onSetBuySellQuantity","amount","onSetSelectedCurrency","currency","onSetBuySellToken"],"mappings":"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","sourcesContent":["import React, { useCallback, useEffect, useState } from 'react'\n\nimport Web3 from 'web3'\nimport { provider } from 'web3-core'\n\nimport { currencyTokens } from 'constants/currencyTokens'\nimport {\n  BedIndex,\n  Bitcoin2xFlexibleLeverageIndex,\n  DataIndex,\n  WLKRInnovation, // Added WLKR\n  Ethereum2xFlexibleLeverageIndex,\n  Ethereum2xFLIP,\n  GmiIndex,\n  IEthereumFLIP,\n  IMaticFLIP,\n  WalkerToken, // Added WLKRR\n  Matic2xFLIP,\n  CandleToken, // Added CNDL\n} from 'constants/productTokens'\nimport { TransactionStatusType } from 'contexts/TransactionWatcher'\nimport useBalances from 'hooks/useBalances'\nimport useTransactionWatcher from 'hooks/useTransactionWatcher'\nimport useWallet from 'hooks/useWallet'\nimport BigNumber from 'utils/bignumber'\nimport { MAINNET_CHAIN_DATA } from 'utils/connectors'\nimport { fromWei, waitTransaction } from 'utils/index'\nimport trackReferral from 'utils/referralApi'\nimport { getZeroExTradeData } from 'utils/zeroExUtils'\n\nimport BuySellContext from './BuySellContext'\nimport { ZeroExData } from './types'\n\nconst BuySellProvider: React.FC = ({ children }) => {\n  const [buySellToken, setBuySellToken] = useState<string>('dpi')\n  const [isFetchingOrderData, setIsFetchingOrderData] = useState<boolean>(false)\n  const [isUserBuying, setIsUserBuying] = useState<boolean>(true)\n  const [activeField, setActiveField] = useState<'currency' | 'set'>('currency')\n  const [buySellQuantity, setBuySellQuantity] = useState<string>('')\n  const [selectedCurrency, setSelectedCurrency] = useState<any>()\n  const [zeroExTradeData, setZeroExTradeData] = useState<ZeroExData>()\n  const [currencyOptions, setCurrencyOptions] = useState<any[]>([])\n\n  const { onSetTransactionId, onSetTransactionStatus } = useTransactionWatcher()\n\n  const {\n    ethBalance,\n    wethBalancePolygon,\n    wlkrBalance, // Added WLKR\n    wlkrBalancePolygon, // Added WLKR\n    wlkrrBalance, // Added WLKRR\n    wlkrrBalancePolygon, // Added WLKRR\n    cndlBalance, // Added CNDL\n    cndlBalancePolygon, // Added CNDL\n    mviBalance,\n    mviBalancePolygon,\n    bedBalance,\n    gmiBalance,\n    dataBalance,\n    dataBalancePolygon,\n    ethfliBalance,\n    ethflipBalance,\n    btcfliBalance,\n    indexBalance,\n    daiBalance,\n    daiBalancePolygon,\n    usdcBalance,\n    usdcBalancePolygon,\n    iethFlipBalance,\n    maticFlipBalancePolygon,\n    imaticFlipBalancePolygon,\n  } = useBalances()\n\n  const { account, ethereum, chainId } = useWallet()\n\n  useEffect(() => {\n    setCurrencyOptions(currencyTokens)\n    setSelectedCurrency(currencyTokens[0])\n  }, [])\n\n  const getNetworkedBalance = (\n    mainnetBalance: any,\n    polygonBalance: any,\n    decimals: number = 18\n  ) => {\n    return chainId && chainId === MAINNET_CHAIN_DATA.chainId\n      ? fromWei(mainnetBalance, decimals)\n      : fromWei(polygonBalance, decimals)\n  }\n\n  // eslint-disable-next-line\n  let spendingTokenBalance = new BigNumber(0)\n  if (!isUserBuying && buySellToken === WalkerToken.tokenSelector) {\n    spendingTokenBalance = fromWei(wlkrrBalance)\n  } else if (!isUserBuying && buySellToken === WLKRInnovation.tokenSelector) {\n    spendingTokenBalance = getNetworkedBalance(wlkrBalance, wlkrBalancePolygon)\n  } else if (\n    !isUserBuying &&\n    buySellToken === Ethereum2xFlexibleLeverageIndex.tokenSelector\n  ) {\n    spendingTokenBalance = fromWei(ethfliBalance)\n  } else if (!isUserBuying && buySellToken === Ethereum2xFLIP.tokenSelector) {\n    spendingTokenBalance = fromWei(ethflipBalance)\n  } else if (!isUserBuying && buySellToken === IEthereumFLIP.tokenSelector) {\n    spendingTokenBalance = fromWei(iethFlipBalance)\n  } else if (!isUserBuying && buySellToken === Matic2xFLIP.tokenSelector) {\n    spendingTokenBalance = fromWei(maticFlipBalancePolygon)\n  } else if (!isUserBuying && buySellToken === IMaticFLIP.tokenSelector) {\n    spendingTokenBalance = fromWei(imaticFlipBalancePolygon)\n  } else if (\n    !isUserBuying &&\n    buySellToken === Bitcoin2xFlexibleLeverageIndex.tokenSelector\n  ) {\n    spendingTokenBalance = fromWei(btcfliBalance)\n  } else if (!isUserBuying && buySellToken === CandleToken.tokenSelector) {\n    spendingTokenBalance = getNetworkedBalance(cndlBalance, cndlBalancePolygon)\n  } else if (!isUserBuying && buySellToken === BedIndex.tokenSelector) {\n    spendingTokenBalance = fromWei(bedBalance)\n  } else if (!isUserBuying && buySellToken === GmiIndex.tokenSelector) {\n    spendingTokenBalance = fromWei(gmiBalance)\n  } else if (!isUserBuying && buySellToken === DataIndex.tokenSelector) {\n    spendingTokenBalance = getNetworkedBalance(dataBalance, dataBalancePolygon)\n  } else if (selectedCurrency?.label === 'ETH') {\n    spendingTokenBalance = getNetworkedBalance(ethBalance, wethBalancePolygon)\n  } else if (selectedCurrency?.label === 'DAI') {\n    spendingTokenBalance = getNetworkedBalance(daiBalance, daiBalancePolygon)\n  } else if (selectedCurrency?.label === 'USDC') {\n    spendingTokenBalance = getNetworkedBalance(\n      usdcBalance,\n      usdcBalancePolygon,\n      6\n    )\n  }\n\n  useEffect(() => {\n    if (!buySellQuantity) return\n\n    setIsFetchingOrderData(true)\n\n    const isExactInputTrade = !isUserBuying || activeField === 'currency'\n\n    getZeroExTradeData(\n      isExactInputTrade,\n      isUserBuying,\n      selectedCurrency.label || '',\n      buySellToken || '',\n      buySellQuantity || '',\n      chainId || 1\n    ).then((data) => {\n      setZeroExTradeData(data)\n      setIsFetchingOrderData(false)\n    })\n  }, [\n    isUserBuying,\n    selectedCurrency,\n    activeField,\n    buySellToken,\n    buySellQuantity,\n    chainId,\n  ])\n\n  const onExecuteBuySell = useCallback(async () => {\n    if (!account || !zeroExTradeData?.sellAmount || !selectedCurrency) return\n\n    let requiredBalance =\n      selectedCurrency === 'usdc'\n        ? fromWei(new BigNumber(zeroExTradeData.sellAmount), 6)\n        : fromWei(new BigNumber(zeroExTradeData?.sellAmount))\n\n    if (spendingTokenBalance.lt(requiredBalance)) return\n\n    const web3 = new Web3(ethereum)\n\n    zeroExTradeData.from = account\n    zeroExTradeData.gas = undefined // use metamask estimated gas limit\n    try {\n      const tx = web3.eth.sendTransaction(zeroExTradeData)\n      onSetTransactionStatus(TransactionStatusType.IS_APPROVING)\n\n      const response = await tx\n\n      onSetTransactionId(response.transactionHash)\n      onSetTransactionStatus(TransactionStatusType.IS_PENDING)\n\n      const isSuccessful = await waitTransaction(\n        ethereum,\n        response.transactionHash\n      )\n      const referralCode = window?.localStorage?.getItem('referral') || ''\n\n      if (isSuccessful) {\n        onSetTransactionStatus(TransactionStatusType.IS_COMPLETED)\n        trackReferral(\n          referralCode,\n          response.transactionHash,\n          'COMPLETED',\n          selectedCurrency,\n          buySellToken,\n          isUserBuying\n        )\n      } else {\n        onSetTransactionStatus(TransactionStatusType.IS_FAILED)\n        trackReferral(\n          referralCode,\n          response.transactionHash,\n          'PENDING OR FAILED',\n          selectedCurrency,\n          buySellToken,\n          isUserBuying\n        )\n      }\n    } catch (e) {\n      // There is a problem here where any error that gets triggered will make it seem like\n      // the transaction failed. For example, the wallet continually polls the chain but fails\n      // to make the network request. The transaction may not have failed, but it would have\n      // triggered this error state.\n      onSetTransactionStatus(TransactionStatusType.IS_FAILED)\n    }\n  }, [\n    account,\n    isUserBuying,\n    selectedCurrency,\n    buySellToken,\n    ethereum,\n    onSetTransactionId,\n    onSetTransactionStatus,\n    spendingTokenBalance,\n    zeroExTradeData,\n  ])\n\n  const onToggleIsUserBuying = () => {\n    // If the user is switching to sell, ensure `set` field can only be selected.\n    if (isUserBuying) {\n      onSetActiveField('set')\n    }\n    setIsUserBuying(!isUserBuying)\n  }\n\n  const onSetActiveField = (field: 'currency' | 'set') => {\n    setActiveField(field)\n\n    if (!isUserBuying) return\n\n    // set BuySellQuantity to the correct value\n    if (field === 'set') {\n      setBuySellQuantity(zeroExTradeData?.displayBuyAmount.toFixed(6) || '')\n    } else {\n      setBuySellQuantity(zeroExTradeData?.displaySellAmount.toFixed(6) || '')\n    }\n  }\n\n  const onSetBuySellQuantity = (amount: string) => {\n    setBuySellQuantity(amount)\n  }\n\n  const onSetSelectedCurrency = (currency: string) => {\n    setSelectedCurrency(currency)\n  }\n\n  return (\n    <BuySellContext.Provider\n      value={{\n        buySellToken,\n        isFetchingOrderData,\n        isUserBuying,\n        activeField,\n        selectedCurrency,\n        spendingTokenBalance,\n        zeroExTradeData,\n        currencyOptions,\n        buySellQuantity,\n        onSetBuySellToken: setBuySellToken,\n        onToggleIsUserBuying,\n        onSetActiveField,\n        onSetSelectedCurrency,\n        onSetBuySellQuantity,\n        onExecuteBuySell,\n      }}\n    >\n      {children}\n    </BuySellContext.Provider>\n  )\n}\n\nexport default BuySellProvider\n"]},"metadata":{},"sourceType":"module"}